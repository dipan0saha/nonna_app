name: CI - Continuous Integration

on:
  push:
    branches: [ main, develop, 'copilot/**' ]
  pull_request:
    branches: [ main, develop, 'copilot/**' ]
  workflow_dispatch:

jobs:
  analyze:
    name: Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Generate localizations
        run: flutter gen-l10n

      - name: Format code
        run: dart format .

      - name: Check for formatting changes
        id: format-check
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit formatting changes
        if: steps.format-check.outputs.has_changes == 'true' && github.event_name == 'pull_request'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "style: auto-format code with dart format"

      - name: Push formatting changes
        if: steps.format-check.outputs.has_changes == 'true' && github.event_name == 'pull_request'
        run: |
          git pull --rebase origin ${{ github.head_ref }}
          git push origin HEAD:${{ github.head_ref }}

      - name: Analyze code
        run: flutter analyze --fatal-infos --fatal-warnings

      - name: Check pub dependencies
        run: flutter pub outdated

  test:
    name: Unit & Widget Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: analyze

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Generate localizations
        run: flutter gen-l10n

      - name: Run tests with coverage
        run: flutter test --coverage --reporter expanded --reporter=json > test-results.json

      - name: Test Report
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: Test Results
          path: 'test-results.json'
          reporter: flutter-json
          fail-on-error: true

      - name: Coverage Report
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: Coverage Report
          path: 'coverage/lcov.info'
          reporter: lcov
          fail-on-error: false

      - name: Generate coverage report
        if: always()
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov
          genhtml coverage/lcov.info -o coverage/html --ignore-errors empty || echo "Coverage report generation skipped (no coverage data)"

      - name: Upload coverage HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/html
          retention-days: 7

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run integration tests
        run: |
          if [ -d "integration_test" ] && [ "$(ls -A integration_test)" ]; then
            flutter test integration_test/
          else
            echo "No integration tests found, skipping..."
          fi

  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build Android APK (Debug)
        run: flutter build apk --debug

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-debug
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7

  build-ios:
    name: Build iOS (Simulator)
    runs-on: macos-latest
    timeout-minutes: 30
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build iOS (Simulator)
        run: flutter build ios --simulator --no-codesign

      - name: Archive iOS build
        run: |
          cd build/ios/iphonesimulator
          zip -r ios-simulator-build.zip Runner.app

      - name: Upload iOS build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-simulator-build
          path: build/ios/iphonesimulator/ios-simulator-build.zip
          retention-days: 7

  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build Web
        run: flutter build web --release

      - name: Upload Web build artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web
          retention-days: 7

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: analyze

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run dependency audit
        run: dart pub deps --json > dependencies.json
        continue-on-error: true

      - name: Check for secrets
        if: hashFiles('.secrets.baseline') != ''
        run: |
          pip install detect-secrets
          detect-secrets scan --baseline .secrets.baseline
        continue-on-error: true

  report-status:
    name: Report CI Status
    runs-on: ubuntu-latest
    needs: [analyze, test, integration-test, build-android, build-web, security-scan, build-ios]
    if: always()

    steps:
      - name: Check job statuses
        run: |
          echo "Analyze: ${{ needs.analyze.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Integration Test: ${{ needs.integration-test.result }}"
          echo "Build Android: ${{ needs.build-android.result }}"
          echo "Build Web: ${{ needs.build-web.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"

          if [[ "${{ needs.analyze.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.integration-test.result }}" != "success" ]] || \
             [[ "${{ needs.build-android.result }}" != "success" ]] || \
             [[ "${{ needs.build-web.result }}" != "success" ]]; then
            echo "❌ CI pipeline failed"
            exit 1
          else
            echo "✅ All CI checks passed"
          fi
