# Analytics Setup Document

## Document Information

**Document Version**: 1.0  
**Last Updated**: January 4, 2026  
**Author**: Technical Team  
**Status**: Configuration Guide  
**Section**: 2.3 - Third-Party Integrations Setup

## Executive Summary

This document provides guidance for setting up analytics tracking for the Nonna App. Analytics enable data-driven product decisions, user engagement measurement, and performance monitoring. This guide covers analytics strategy, event tracking implementation, privacy-compliant configuration, and recommended analytics tools.

## References

- `docs/00_requirement_gathering/success_metrics_kpis.md` - Success metrics and KPIs
- `docs/01_technical_requirements/api_integration_plan.md` - Analytics integration (Section 3.3)
- `docs/02_architecture_design/security_privacy_architecture.md` - Privacy requirements
- `docs/Production_Readiness_Checklist.md` - Section 2.3 requirements

---

## 1. Analytics Strategy

### 1.1 Analytics Goals

**Primary Goals**:
1. **User Engagement**: Measure active users, session duration, feature adoption
2. **Product Performance**: Track key user flows, conversion funnels, drop-off points
3. **Technical Performance**: Monitor app crashes, API latency, load times
4. **Business Metrics**: Track retention, churn, viral coefficient (invitations)

**Key Metrics** (from success_metrics_kpis.md):
- Daily Active Users (DAU)
- Monthly Active Users (MAU)
- Photos uploaded per user per month
- Average session duration
- Invitation acceptance rate
- User retention (D1, D7, D30)
- Feature adoption rates (events, registry, comments)

### 1.2 Privacy-First Analytics

**Privacy Principles**:
- **Opt-in Analytics**: Users must explicitly consent
- **No PII**: Never collect personally identifiable information
- **User Control**: Users can opt out at any time
- **Data Minimization**: Collect only necessary data
- **Transparent**: Clear privacy policy explaining analytics
- **GDPR/CCPA Compliant**: Follow data protection regulations

---

## 2. Recommended Analytics Tools

### 2.1 Tool Comparison

| Tool | Free Tier | Privacy-Focused | Real-Time | Cost (Paid) |
|------|-----------|-----------------|-----------|-------------|
| **Firebase Analytics** | Yes (Unlimited) | No (Google-owned) | Yes | Free |
| **Mixpanel** | 100K events/month | Moderate | Yes | $25/mo |
| **Amplitude** | 10M events/month | Yes (GDPR compliant) | Yes | $49/mo |
| **PostHog** | 1M events/month | Yes (self-hosted option) | Yes | $0-450/mo |
| **Plausible** | No free tier | Yes (privacy-first) | Yes | $9/mo |

**Recommendation for Nonna App**: **Amplitude** or **Firebase Analytics**

- **Amplitude**: Best for product analytics, retention analysis, user segmentation
- **Firebase Analytics**: Best for mobile apps, free, integrates with Firebase suite

### 2.2 Firebase Analytics Setup (Recommended)

**Why Firebase Analytics**:
- Free and unlimited
- Native Flutter support
- Real-time dashboard
- Integrates with Firebase Crashlytics, Performance Monitoring
- Automatic event tracking (screen views, app opens, first opens)

**Limitations**:
- Google-owned (privacy concerns for some users)
- Less powerful than Amplitude for advanced cohort analysis
- Limited data export options

---

## 3. Firebase Analytics Implementation

### 3.1 Setup Firebase Project

1. Navigate to [Firebase Console](https://console.firebase.google.com/)
2. Click "Add project"
3. Enter project name: "Nonna App"
4. Enable Google Analytics for project
5. Configure Google Analytics account (or create new)
6. Complete project creation

### 3.2 Add Firebase to Flutter App

**Install Dependencies**:

```yaml
# pubspec.yaml
dependencies:
  firebase_core: ^2.24.0
  firebase_analytics: ^10.8.0
```

**Download Configuration Files**:

**Android**:
1. Firebase Console → Project Settings → Add app → Android
2. Enter package name: `com.nonna.app`
3. Download `google-services.json`
4. Place in `android/app/google-services.json`
5. Add Firebase SDK to `android/build.gradle`:
   ```gradle
   buildscript {
     dependencies {
       classpath 'com.google.gms:google-services:4.4.0'
     }
   }
   ```
6. Apply plugin in `android/app/build.gradle`:
   ```gradle
   apply plugin: 'com.google.gms.google-services'
   ```

**iOS**:
1. Firebase Console → Project Settings → Add app → iOS
2. Enter Bundle ID: `com.nonna.app`
3. Download `GoogleService-Info.plist`
4. Add to `ios/Runner/` in Xcode
5. Ensure file is added to target

### 3.3 Initialize Firebase

```dart
// lib/main.dart

import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_analytics/firebase_analytics.dart';
import 'firebase_options.dart'; // Generated by FlutterFire CLI

Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // Initialize Firebase
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );
  
  // Initialize Supabase
  await Supabase.initialize(
    url: SupabaseConfig.supabaseUrl,
    anonKey: SupabaseConfig.supabaseAnonKey,
  );
  
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  // Create FirebaseAnalytics instance
  static FirebaseAnalytics analytics = FirebaseAnalytics.instance;
  static FirebaseAnalyticsObserver observer = 
      FirebaseAnalyticsObserver(analytics: analytics);

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Nonna App',
      navigatorObservers: [observer], // Auto-track screen views
      home: SplashScreen(),
    );
  }
}
```

---

## 4. Event Tracking Implementation

### 4.1 Core Events

**Authentication Events**:

```dart
// User signs up
await FirebaseAnalytics.instance.logSignUp(signUpMethod: 'email');
await FirebaseAnalytics.instance.logSignUp(signUpMethod: 'google');

// User logs in
await FirebaseAnalytics.instance.logLogin(loginMethod: 'email');

// Set user properties
await FirebaseAnalytics.instance.setUserId(id: userId);
await FirebaseAnalytics.instance.setUserProperty(
  name: 'user_type',
  value: 'owner', // or 'follower'
);
```

**Baby Profile Events**:

```dart
// Baby profile created
await FirebaseAnalytics.instance.logEvent(
  name: 'baby_profile_created',
  parameters: {
    'baby_profile_id': babyProfileId,
    'has_photo': hasPhoto,
    'gender': gender,
  },
);

// Baby profile followed
await FirebaseAnalytics.instance.logEvent(
  name: 'baby_profile_followed',
  parameters: {
    'baby_profile_id': babyProfileId,
    'invitation_method': 'email', // or 'link'
  },
);
```

**Photo Events**:

```dart
// Photo uploaded
await FirebaseAnalytics.instance.logEvent(
  name: 'photo_uploaded',
  parameters: {
    'baby_profile_id': babyProfileId,
    'has_caption': hasCaption,
    'has_tags': hasTags,
    'file_size_kb': fileSizeKB,
  },
);

// Photo viewed
await FirebaseAnalytics.instance.logEvent(
  name: 'photo_viewed',
  parameters: {
    'photo_id': photoId,
    'baby_profile_id': babyProfileId,
  },
);

// Photo commented
await FirebaseAnalytics.instance.logEvent(
  name: 'photo_commented',
  parameters: {
    'photo_id': photoId,
    'baby_profile_id': babyProfileId,
    'comment_length': commentLength,
  },
);

// Photo squished (liked)
await FirebaseAnalytics.instance.logEvent(
  name: 'photo_squished',
  parameters: {
    'photo_id': photoId,
    'baby_profile_id': babyProfileId,
  },
);
```

**Event Events**:

```dart
// Event created
await FirebaseAnalytics.instance.logEvent(
  name: 'event_created',
  parameters: {
    'event_id': eventId,
    'baby_profile_id': babyProfileId,
    'has_location': hasLocation,
    'has_cover_photo': hasCoverPhoto,
  },
);

// Event RSVP
await FirebaseAnalytics.instance.logEvent(
  name: 'event_rsvp',
  parameters: {
    'event_id': eventId,
    'baby_profile_id': babyProfileId,
    'rsvp_status': rsvpStatus, // 'attending', 'not_attending', 'maybe'
  },
);
```

**Registry Events**:

```dart
// Registry item added
await FirebaseAnalytics.instance.logEvent(
  name: 'registry_item_added',
  parameters: {
    'item_id': itemId,
    'baby_profile_id': babyProfileId,
    'has_url': hasUrl,
    'priority': priority,
  },
);

// Registry item purchased
await FirebaseAnalytics.instance.logEvent(
  name: 'registry_item_purchased',
  parameters: {
    'item_id': itemId,
    'baby_profile_id': babyProfileId,
    'quantity': quantity,
  },
);
```

**Invitation Events**:

```dart
// Invitation sent
await FirebaseAnalytics.instance.logEvent(
  name: 'invitation_sent',
  parameters: {
    'baby_profile_id': babyProfileId,
    'relationship_type': relationshipType,
  },
);

// Invitation accepted
await FirebaseAnalytics.instance.logEvent(
  name: 'invitation_accepted',
  parameters: {
    'baby_profile_id': babyProfileId,
    'time_to_accept_hours': timeToAcceptHours,
  },
);
```

### 4.2 Screen View Tracking

**Automatic Tracking** (via NavigatorObserver):

```dart
// Automatic screen view tracking when using named routes
MaterialApp(
  navigatorObservers: [
    FirebaseAnalyticsObserver(analytics: FirebaseAnalytics.instance),
  ],
  routes: {
    '/home': (context) => HomeScreen(),
    '/photo-gallery': (context) => PhotoGalleryScreen(),
    '/photo-detail': (context) => PhotoDetailScreen(),
  },
);
```

**Manual Tracking** (for custom navigation):

```dart
Future<void> _trackScreenView(String screenName) async {
  await FirebaseAnalytics.instance.logScreenView(
    screenName: screenName,
    screenClass: screenName,
  );
}

// Usage
@override
void initState() {
  super.initState();
  _trackScreenView('PhotoGalleryScreen');
}
```

### 4.3 User Properties

```dart
// Set user properties for segmentation
Future<void> setUserProperties() async {
  final userId = Supabase.instance.client.auth.currentUser!.id;
  
  await FirebaseAnalytics.instance.setUserId(id: userId);
  
  await FirebaseAnalytics.instance.setUserProperty(
    name: 'account_age_days',
    value: accountAgeDays.toString(),
  );
  
  await FirebaseAnalytics.instance.setUserProperty(
    name: 'num_baby_profiles',
    value: numBabyProfiles.toString(),
  );
  
  await FirebaseAnalytics.instance.setUserProperty(
    name: 'is_owner',
    value: isOwner.toString(),
  );
}
```

---

## 5. Privacy and Compliance

### 5.1 Analytics Consent

**Request User Consent**:

```dart
class AnalyticsService {
  static bool _analyticsEnabled = false;

  static Future<void> requestAnalyticsConsent(BuildContext context) async {
    final consent = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('Help Us Improve'),
        content: Text(
          'We use analytics to understand how you use the app and improve your experience. '
          'No personally identifiable information is collected. '
          'You can change this setting anytime in Settings.',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: Text('No Thanks'),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context, true),
            child: Text('Enable Analytics'),
          ),
        ],
      ),
    );

    if (consent == true) {
      await enableAnalytics();
    } else {
      await disableAnalytics();
    }
  }

  static Future<void> enableAnalytics() async {
    await FirebaseAnalytics.instance.setAnalyticsCollectionEnabled(true);
    _analyticsEnabled = true;
    
    // Save preference
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool('analytics_enabled', true);
  }

  static Future<void> disableAnalytics() async {
    await FirebaseAnalytics.instance.setAnalyticsCollectionEnabled(false);
    _analyticsEnabled = false;
    
    // Save preference
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool('analytics_enabled', false);
  }

  static bool get isEnabled => _analyticsEnabled;
}
```

**Settings Screen**:

```dart
SwitchListTile(
  title: Text('Analytics'),
  subtitle: Text('Help us improve the app with anonymous usage data'),
  value: AnalyticsService.isEnabled,
  onChanged: (value) async {
    if (value) {
      await AnalyticsService.enableAnalytics();
    } else {
      await AnalyticsService.disableAnalytics();
    }
    setState(() {});
  },
)
```

### 5.2 Data Minimization

**Avoid Collecting PII**:

```dart
// ❌ DON'T: Log PII
await FirebaseAnalytics.instance.logEvent(
  name: 'user_registered',
  parameters: {
    'email': userEmail, // PII - don't log
    'name': userName, // PII - don't log
  },
);

// ✅ DO: Log anonymized data
await FirebaseAnalytics.instance.logEvent(
  name: 'user_registered',
  parameters: {
    'signup_method': 'email',
    'has_profile_photo': hasProfilePhoto,
  },
);
```

---

## 6. Analytics Dashboard and Reporting

### 6.1 Key Reports

**Firebase Console Reports**:

1. **Overview**: DAU, MAU, sessions, engagement time
2. **Retention**: User retention cohorts (D1, D7, D30)
3. **Events**: Top events, event parameters, event trends
4. **Funnels**: Conversion funnels (e.g., signup → create profile → upload photo)
5. **Demographics**: Age, gender, location (if enabled)
6. **User Properties**: Segment users by custom properties

### 6.2 Custom Dashboards

**Create Custom Dashboard**:

1. Firebase Console → Analytics → Custom Dashboards
2. Add widgets:
   - Active users over time
   - Photos uploaded per day
   - Invitation acceptance rate
   - Feature adoption (events, registry)
   - Top baby profiles by activity
3. Save and share with team

---

## 7. Performance Monitoring

### 7.1 Firebase Performance Monitoring

**Setup**:

```yaml
# pubspec.yaml
dependencies:
  firebase_performance: ^0.9.3
```

**Automatic Monitoring**:

Firebase Performance automatically monitors:
- App start time
- HTTP/HTTPS network requests
- Screen rendering performance

**Custom Traces**:

```dart
import 'package:firebase_performance/firebase_performance.dart';

// Track custom performance metric
Future<void> uploadPhotoWithPerformanceTracking() async {
  final trace = FirebasePerformance.instance.newTrace('photo_upload');
  await trace.start();
  
  try {
    await uploadPhoto();
    trace.setMetric('photo_size_kb', photoSizeKB);
    trace.setMetric('compression_time_ms', compressionTimeMs);
  } finally {
    await trace.stop();
  }
}
```

### 7.2 Crash Reporting

**Setup Firebase Crashlytics**:

```yaml
# pubspec.yaml
dependencies:
  firebase_crashlytics: ^3.4.0
```

```dart
// Initialize Crashlytics
await FirebaseCrashlytics.instance.setCrashlyticsCollectionEnabled(true);

// Set up Flutter error handling
FlutterError.onError = FirebaseCrashlytics.instance.recordFlutterFatalError;

// Catch async errors
PlatformDispatcher.instance.onError = (error, stack) {
  FirebaseCrashlytics.instance.recordError(error, stack, fatal: true);
  return true;
};
```

---

## 8. Testing Analytics

### 8.1 Debug View (Firebase)

**Enable Debug Mode**:

**iOS**:
```bash
# Add to Xcode scheme arguments
-FIRAnalyticsDebugEnabled
```

**Android**:
```bash
# Enable via ADB
adb shell setprop debug.firebase.analytics.app com.nonna.app

# Disable
adb shell setprop debug.firebase.analytics.app .none.
```

**View Events**: Firebase Console → DebugView → Select device

### 8.2 Test Event Logging

```dart
// Test events in development
if (kDebugMode) {
  await FirebaseAnalytics.instance.logEvent(
    name: 'test_event',
    parameters: {'test_param': 'test_value'},
  );
  print('Test event logged');
}
```

---

## 9. Production Checklist

- [ ] Firebase project created and configured
- [ ] Firebase Analytics SDK integrated
- [ ] Core events implemented and tested
- [ ] Screen view tracking functional
- [ ] User properties set correctly
- [ ] Analytics consent implemented
- [ ] Privacy policy updated with analytics disclosure
- [ ] PII exclusions verified
- [ ] Performance monitoring enabled
- [ ] Crashlytics configured
- [ ] Custom dashboard created
- [ ] Analytics tested in debug mode
- [ ] Team trained on analytics dashboard

---

## Conclusion

This Analytics Setup Document provides comprehensive guidance for implementing privacy-compliant analytics tracking in the Nonna App using Firebase Analytics. Following these guidelines ensures data-driven product decisions while respecting user privacy.

**Key Takeaways**:

- **Privacy-first**: Always request user consent, never collect PII
- **Event-driven**: Track key user actions for product insights
- **Performance**: Monitor app performance and crashes
- **Data-driven**: Use analytics to inform product decisions

---

**Document Version**: 1.0  
**Last Updated**: January 4, 2026  
**Status**: Configuration Guide - Ready for Implementation
