# Flutter Project Setup Guide - Story 15.1

This document provides detailed instructions for setting up the Nonna App Flutter project with Android configuration, Supabase integration, and environment variables.

## Overview

The Nonna App is a Flutter application using Supabase as the backend. This setup guide covers:
- Flutter project structure
- Android configuration (app ID, package name)
- Android signing configuration for release builds
- Environment variables for Supabase credentials
- Supabase initialization

## Project Structure

```
nonna_app/
├── android/                    # Android-specific configuration
│   ├── app/
│   │   ├── src/main/kotlin/com/nonna/app/
│   │   │   └── MainActivity.kt
│   │   └── build.gradle.kts   # Android build configuration
│   ├── key.properties.example  # Template for signing configuration
│   └── ...
├── lib/                       # Flutter application code
│   ├── main.dart             # App entry point with Supabase initialization
│   └── utils/                # Utility libraries
├── .env.example              # Template for environment variables
├── .gitignore               # Git ignore rules (excludes .env and keys)
└── pubspec.yaml             # Flutter dependencies
```

## 1. Android Configuration

### 1.1 Application ID

The app is configured with a proper application ID:
- **Package Name:** `com.nonna.app`
- **Namespace:** `com.nonna.app`

This is configured in:
- `android/app/build.gradle.kts`: `applicationId = "com.nonna.app"`
- `android/app/build.gradle.kts`: `namespace = "com.nonna.app"`
- `android/app/src/main/kotlin/com/nonna/app/MainActivity.kt`

### 1.2 Android Manifest

The AndroidManifest.xml is configured with:
- App label: "nonna_app"
- Main launcher activity
- Required permissions and intents

Location: `android/app/src/main/AndroidManifest.xml`

## 2. Android Signing Configuration

### 2.1 For Development

Debug signing is automatically handled by Flutter. No additional configuration is needed for development builds.

### 2.2 For Release Builds

The project supports custom signing configuration for release builds:

1. **Generate a keystore** (one-time setup):
   ```bash
   keytool -genkey -v -keystore ~/nonna-release-key.jks \
     -storetype PKCS12 -keyalg RSA -keysize 2048 -validity 10000 -alias nonna
   ```
   
   **Note**: We use PKCS12 format as JKS is deprecated. The `-storetype PKCS12` parameter ensures modern compatibility.

2. **Create signing configuration**:
   - Copy `android/key.properties.example` to `android/key.properties`
   - Fill in your keystore details:
     ```properties
     storeFile=/path/to/your/nonna-release-key.jks
     storePassword=your_store_password
     keyAlias=nonna
     keyPassword=your_key_password
     ```

3. **Security**: The `key.properties` file and keystore files are excluded from version control via `.gitignore`

4. **Build process**: `android/app/build.gradle.kts` automatically loads signing configuration from `key.properties` if it exists. If not found, debug signing is used (for development).

## 3. Environment Variables Configuration

### 3.1 Supabase Credentials

The app uses environment variables to securely manage Supabase credentials:

1. **Create `.env` file**:
   ```bash
   cp .env.example .env
   ```

2. **Add your Supabase credentials** to `.env`:
   ```
   SUPABASE_URL=https://your-project.supabase.co
   SUPABASE_ANON_KEY=your-anon-key-here
   ```

3. **Get Supabase credentials**:
   - Go to [Supabase Dashboard](https://app.supabase.com)
   - Select your project
   - Navigate to Settings > API
   - Copy "Project URL" and "anon public" key

### 3.2 Security

- `.env` file is excluded from version control (in `.gitignore`)
- `.env.example` provides a template without sensitive data
- Never commit actual credentials to version control

### 3.3 Implementation

The project uses `flutter_dotenv` package to load environment variables:

**In `pubspec.yaml`**:
```yaml
dependencies:
  flutter_dotenv: ^5.1.0

flutter:
  assets:
    - .env
```

**In `lib/main.dart`**:
```dart
import 'package:flutter_dotenv/flutter_dotenv.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // Load environment variables
  await dotenv.load(fileName: ".env");
  
  // Validate required environment variables
  final supabaseUrl = dotenv.env['SUPABASE_URL'];
  final supabaseAnonKey = dotenv.env['SUPABASE_ANON_KEY'];

  if (supabaseUrl == null || supabaseUrl.isEmpty) {
    throw Exception(
      'SUPABASE_URL is not set. Please create a .env file with your Supabase credentials.',
    );
  }

  if (supabaseAnonKey == null || supabaseAnonKey.isEmpty) {
    throw Exception(
      'SUPABASE_ANON_KEY is not set. Please create a .env file with your Supabase credentials.',
    );
  }
  
  // Initialize Supabase
  await Supabase.initialize(
    url: supabaseUrl,
    anonKey: supabaseAnonKey,
    authOptions: const FlutterAuthClientOptions(
      authFlowType: AuthFlowType.pkce,
    ),
  );
  
  runApp(const MyApp());
}

// Global accessor for Supabase client
final supabase = Supabase.instance.client;
```

## 4. Supabase Initialization

### 4.1 Configuration

Supabase is initialized in `main.dart` with:
- **URL**: Loaded from `SUPABASE_URL` environment variable
- **Anon Key**: Loaded from `SUPABASE_ANON_KEY` environment variable
- **Auth Flow**: PKCE (Proof Key for Code Exchange) for enhanced security
- **Global Client**: Accessible via `supabase` variable throughout the app

### 4.2 Usage

After initialization, you can use Supabase throughout the app:

```dart
import 'package:nonna_app/main.dart';

// Example: Sign in
final response = await supabase.auth.signInWithPassword(
  email: 'user@example.com',
  password: 'password',
);

// Example: Query data
final data = await supabase
  .from('profiles')
  .select()
  .eq('id', userId)
  .single();
```

## 5. Dependencies

### 5.1 Core Dependencies

```yaml
dependencies:
  flutter:
    sdk: flutter
  supabase_flutter: ^2.0.0      # Supabase SDK
  flutter_dotenv: ^5.1.0        # Environment variable management
  cupertino_icons: ^1.0.8       # iOS-style icons
  intl: ^0.19.0                 # Internationalization
  image: ^4.1.7                 # Image processing
  http: ^1.2.0                  # HTTP client
```

### 5.2 Dev Dependencies

```yaml
dev_dependencies:
  flutter_test:
    sdk: flutter
  integration_test:
    sdk: flutter
  test: ^1.24.0
  flutter_lints: ^6.0.0
  mockito: ^5.4.4
  build_runner: ^2.4.8
```

## 6. Getting Started Checklist

### Initial Setup
- [x] Flutter project created
- [x] Android configuration completed
- [x] Package name updated to `com.nonna.app`
- [x] MainActivity moved to correct package structure
- [x] Supabase Flutter SDK added to dependencies
- [x] flutter_dotenv added for environment variables
- [x] .env.example created with template
- [x] .gitignore updated to exclude sensitive files

### Developer Setup (Required for each developer)
- [ ] Clone repository
- [ ] Run `flutter pub get`
- [ ] Copy `.env.example` to `.env`
- [ ] Add Supabase credentials to `.env`
- [ ] (Optional for release) Create `android/key.properties` with signing config
- [ ] Run `flutter run` to verify setup

## 7. Build Commands

### Development Build
```bash
# Android
flutter run

# iOS
flutter run -d ios

# Web
flutter run -d chrome
```

### Release Build (Android)
```bash
# Build APK
flutter build apk --release

# Build App Bundle (for Google Play)
flutter build appbundle --release
```

**Note**: Release builds require proper signing configuration in `android/key.properties`.

## 8. Troubleshooting

### Issue: "Unable to load asset: .env"
**Solution**: Ensure `.env` file exists in the root directory and is listed in `pubspec.yaml` assets.

### Issue: "SUPABASE_URL or SUPABASE_ANON_KEY is null"
**Solution**: Check that `.env` file contains valid values for both variables.

### Issue: Release build fails with signing error
**Solution**: Verify `android/key.properties` exists and contains correct keystore information.

### Issue: Package name conflicts
**Solution**: Ensure all references to `com.example.nonna_app` are updated to `com.nonna.app`:
- `android/app/build.gradle.kts`
- `android/app/src/main/kotlin/com/nonna/app/MainActivity.kt`

## 9. Security Best Practices

1. **Never commit sensitive files**:
   - `.env` (contains Supabase credentials)
   - `android/key.properties` (contains signing passwords)
   - `*.jks` or `*.keystore` files (signing keys)

2. **Use secure storage**:
   - Store keystore files outside the repository
   - Use CI/CD secrets for automation
   - Rotate keys periodically

3. **Environment-specific configuration**:
   - Use different Supabase projects for dev/staging/production
   - Never use production credentials in development

## 10. Related Documentation

- [Supabase Implementation Guide](../02_pre_development_epics/1.1_feasibility_study/supabase-implementation-guide.md)
- [Flutter Documentation](https://docs.flutter.dev/)
- [Supabase Flutter SDK](https://supabase.com/docs/reference/dart/introduction)
- [Android App Signing](https://developer.android.com/studio/publish/app-signing)

## 11. Next Steps

After completing this setup, you can proceed to:
- **Story 15.2**: Integrate Supabase SDK for auth and database setup
- **Story 15.3**: Configure local development tools
- **Story 15.4**: Set up version control and CI/CD

---

**Document Status**: Complete  
**Last Updated**: December 2024  
**Story**: 15.1 - Flutter Project Creation  
**Epic**: 15 - Local Project Setup
